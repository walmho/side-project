Work on cleaning up functions
See if global vars are really needed

